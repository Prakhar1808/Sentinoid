package com.sentinoid.shield

import android.content.Context
import android.content.res.AssetFileDescriptor
import android.util.Log
import org.tensorflow.lite.Interpreter
import java.io.FileInputStream
import java.io.IOException
import java.nio.MappedByteBuffer
import java.nio.channels.FileChannel

class MalwareEngine(private val context: Context) {
    private var tflite: Interpreter? = null

    init {
        try {
            tflite = Interpreter(loadModelFile())
            Log.d("MalwareEngine", "TensorFlow Lite model loaded successfully.")
        } catch (e: IOException) {
            Log.e("MalwareEngine", "Error loading TensorFlow Lite model.", e)
        }
    }

    private fun loadModelFile(): MappedByteBuffer {
        val fileDescriptor: AssetFileDescriptor = context.assets.openFd("malware_detector.tflite")
        val inputStream = FileInputStream(fileDescriptor.fileDescriptor)
        val fileChannel = inputStream.channel
        return fileChannel.map(FileChannel.MapMode.READ_ONLY, fileDescriptor.startOffset, fileDescriptor.declaredLength)
    }

    fun analyzeApp(permissionVector: FloatArray): Float {
        if (tflite == null) {
            Log.e("MalwareEngine", "TensorFlow Lite interpreter is not initialized.")
            return 0.0f
        }
        // Example: permissionVector contains [has_sms, has_camera, has_gps...]
        val output = Array(1) { FloatArray(1) }
        tflite?.run(arrayOf(permissionVector), output)
        
        // Return the 'Maliciousness' probability (0.0 to 1.0)
        return output[0][0]
    }
}
